<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Result</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --background: #f0f2f5; --card-bg: #ffffff; --text-primary: #1c1e21; --text-secondary: #606770; --accent: #0866ff; --leaderboard: #f1c40f; }
        body { font-family: 'Inter', sans-serif; background-color: var(--background); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .result-summary { background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); text-align: center; margin-bottom: 30px; }
        .result-summary h1 { color: var(--text-primary); margin-top: 0; font-size: 1.8rem; }
        .result-summary p { font-size: 1.5rem; font-weight: 500; color: var(--accent); margin: 10px 0 25px 0; }
        .action-buttons { display: flex; justify-content: center; gap: 15px; }
        .action-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 25px; text-decoration: none; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; transition: opacity 0.2s; }
        #reattempt-btn { background-color: var(--accent); color: white; }
        #leaderboard-btn { background-color: var(--leaderboard); color: white; }
        .review-container h2 { text-align: center; color: var(--text-secondary); margin: 40px 0 20px 0; font-weight: 500; }
        .review-container .question-block { background: var(--card-bg); margin-bottom: 20px; padding: 20px; border-radius: 8px; border-left: 5px solid #bdc3c7; }
        .review-container .question-block.correct { border-left-color: #2ecc71; }
        .review-container .question-block.incorrect { border-left-color: #e74c3c; }
        .question-text { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }
        .question-text img, .option-item img { max-width: 100%; height: auto; border-radius: 4px; }
        .option-item { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #eee; }
        .option-item.correct-answer { background-color: #dff9e6; border-color: #2ecc71; font-weight: bold; }
        .option-item.wrong-answer { background-color: #fbecec; border-color: #e74c3c; text-decoration: line-through; }
        .solution { margin-top: 15px; padding: 10px; background: #ecf0f1; border-radius: 4px; color: #34495e; }
    </style>
</head>
<body>
    <div class="container">
        <div id="result-summary" class="result-summary">
            <h1>Test Result</h1>
            <p id="score-text">Calculating...</p>
            <div class="action-buttons">
                <button id="reattempt-btn" class="action-btn">Re-attempt</button>
                <a id="leaderboard-btn" href="#" class="action-btn">Leaderboard</a>
            </div>
        </div>
        <div id="review-container" class="review-container">
            <h2>Review Your Answers</h2>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDVIgUAmKlJqwvkd9kblaujzIVlSq9_EiM", authDomain: "tests-data-with-leaderboard.firebaseapp.com", projectId: "tests-data-with-leaderboard", storageBucket: "tests-data-with-leaderboard.firebasestorage.app", messagingSenderId: "884648979462", appId: "1:884648979462:web:446df6ccb02bf73397e787", measurementId: "G-701ZP61XZT" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.onload = async () => {
            const studentName = localStorage.getItem('studentName');
            const urlParams = new URLSearchParams(window.location.search);
            const testId = urlParams.get('testid');

            if (!studentName || !testId) {
                document.body.innerHTML = '<h1>Error: Missing student or test info.</h1>';
                return;
            }
            
            const resultKey = `result_${studentName}_${testId}`;
            const resultPayload = JSON.parse(localStorage.getItem(resultKey));

            if (!resultPayload) {
                document.body.innerHTML = `<h1>Error: No result found. <a href="2.html?class=YourClass">Go back to test list.</a></h1>`;
                return;
            }

            const { testData, userAnswers, isNew } = resultPayload;
            const reviewContainer = document.getElementById('review-container');
            let score = 0;

            testData.questions.forEach((q, index) => {
                const isCorrect = (q.correctAnswerIndex === userAnswers[index]);
                if (isCorrect) score++;
                const questionBlock = document.createElement('div');
                questionBlock.className = `question-block ${isCorrect ? 'correct' : 'incorrect'}`;
                let questionHTML = q.isQuestionImage ? `<img src="${q.questionText}" alt="Question">` : q.questionText;
                let optionsHTML = q.options.map((opt, i) => {
                    let classes = 'option-item';
                    if (i === q.correctAnswerIndex) classes += ' correct-answer';
                    if (i === userAnswers[index] && !isCorrect) classes += ' wrong-answer';
                    let optionContent = opt.isOptionImage ? `<img src="${opt.optionText}" alt="Option">` : opt.optionText;
                    return `<div class="${classes}">${optionContent}</div>`;
                }).join('');
                questionBlock.innerHTML = `<div class="question-text">Q${index + 1}: ${questionHTML}</div><div class="options">${optionsHTML}</div><div class="solution"><strong>Solution:</strong> ${q.solution || 'No solution provided.'}</div>`;
                reviewContainer.appendChild(questionBlock);
            });

            document.getElementById('score-text').textContent = `You scored ${score} out of ${testData.questions.length}.`;
            document.getElementById('leaderboard-btn').href = `5.html?testid=${testId}&class=${testData.className}`;

            document.getElementById('reattempt-btn').onclick = () => {
                if (confirm('This will clear your current result and let you take the test again. Continue?')) {
                    localStorage.removeItem(resultKey);
                    const completedKey = `completedTests_${studentName}_${testData.className}`;
                    let completedTests = JSON.parse(localStorage.getItem(completedKey)) || {};
                    delete completedTests[testId];
                    localStorage.setItem(completedKey, JSON.stringify(completedTests));
                    window.location.href = `3.html?testid=${testId}`;
                }
            };

            if (isNew) {
                await saveToLeaderboard(testId, studentName, score, testData.questions.length);
                const completedKey = `completedTests_${studentName}_${testData.className}`;
                let completedTests = JSON.parse(localStorage.getItem(completedKey)) || {};
                completedTests[testId] = true;
                localStorage.setItem(completedKey, JSON.stringify(completedTests));
                resultPayload.isNew = false;
                localStorage.setItem(resultKey, JSON.stringify(resultPayload));
            }
        };

        async function saveToLeaderboard(testId, studentName, score, totalQuestions) {
            try {
                await db.collection('leaderboard').add({ testId, studentName, score, totalQuestions, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                console.log('Score saved to leaderboard.');
            } catch (error) { console.error("Error saving to leaderboard: ", error); }
        }
    </script>
</body>
</html>
