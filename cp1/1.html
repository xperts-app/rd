<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="url"], select, textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 100px; }
        .btn {
            display: inline-block; background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; text-align: center;
        }
        .btn:hover { background-color: #0056b3; }
        .hidden { display: none; }
        .status-message {
            padding: 15px; margin-top: 20px; border-radius: 4px; font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .option-group { border: 1px solid #eee; padding: 15px; margin-top: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Admin Panel</h1>
        <h2>Add a New Question</h2>

        <form id="questionForm">
            <!-- Class and Subject Selection -->
            <div class="form-group">
                <label for="classSelect">Class</label>
                <select id="classSelect" required>
                    <option value="">-- Select Class --</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11 JEE">11 JEE</option>
                    <option value="11 NEET">11 NEET</option>
                    <option value="12 JEE">12 JEE</option>
                    <option value="12 NEET">12 NEET</option>
                </select>
            </div>

            <div class="form-group">
                <label for="subjectSelect">Subject</label>
                <select id="subjectSelect" required disabled>
                    <option value="">-- Select Class First --</option>
                </select>
            </div>

            <!-- Chapter Selection -->
            <div class="form-group">
                <label>Chapter</label>
                <input type="radio" id="existingChapterRadio" name="chapterChoice" value="existing" checked>
                <label for="existingChapterRadio">Use Existing Chapter</label>
                <input type="radio" id="newChapterRadio" name="chapterChoice" value="new">
                <label for="newChapterRadio">Add New Chapter</label>
            </div>

            <div id="existingChapterGroup" class="form-group">
                <label for="chapterSelect">Select Existing Chapter</label>
                <select id="chapterSelect"></select>
            </div>
            <div id="newChapterGroup" class="form-group hidden">
                <label for="newChapterInput">New Chapter Name</label>
                <input type="text" id="newChapterInput" placeholder="e.g., Kinematics">
            </div>

            <hr>

            <!-- Question Details -->
            <div class="form-group">
                <label for="questionText">Question Text (Optional if Image-only)</label>
                <textarea id="questionText" placeholder="Enter the question text here..."></textarea>
            </div>
            <div class="form-group">
                <label for="questionImage">Question Image URL (Optional)</label>
                <input type="url" id="questionImage" placeholder="https://example.com/image.png">
            </div>

            <!-- Options -->
            <h2>Options</h2>
            <div id="optionsContainer">
                <!-- Options will be generated by JS -->
            </div>

            <div class="form-group">
                <label for="correctAnswer">Correct Answer</label>
                <select id="correctAnswer" required>
                    <option value="0">Option 1</option>
                    <option value="1">Option 2</option>
                    <option value="2">Option 3</option>
                    <option value="3">Option 4</option>
                </select>
            </div>

             <div class="form-group">
                <label for="detailedSolution">Detailed Solution</label>
                <textarea id="detailedSolution" placeholder="Explain the correct answer in detail." required></textarea>
            </div>

            <button type="submit" class="btn">Save Question</button>
        </form>

        <div id="statusMessage" class="status-message hidden"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyBrdCOyTrQ_uU4jID8hWzCQzaXilhAcGcs",
          authDomain: "custom-practices.firebaseapp.com",
          projectId: "custom-practices",
          storageBucket: "custom-practices.firebasestorage.app",
          messagingSenderId: "636700937539",
          appId: "1:636700937539:web:d6ec9d88453e15481d33f6",
          measurementId: "G-JL58DMTZ0W"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- DOM ELEMENTS ---
        const classSelect = document.getElementById('classSelect');
        const subjectSelect = document.getElementById('subjectSelect');
        const chapterSelect = document.getElementById('chapterSelect');
        const newChapterInput = document.getElementById('newChapterInput');
        const existingChapterRadio = document.getElementById('existingChapterRadio');
        const newChapterRadio = document.getElementById('newChapterRadio');
        const existingChapterGroup = document.getElementById('existingChapterGroup');
        const newChapterGroup = document.getElementById('newChapterGroup');
        const form = document.getElementById('questionForm');
        const statusMessage = document.getElementById('statusMessage');
        const optionsContainer = document.getElementById('optionsContainer');

        // --- SUBJECT MAPPINGS ---
        const subjects = {
            '6': ['PHY', 'CHEM', 'BIO', 'MATH', 'ENG', 'SST'],
            '7': ['PHY', 'CHEM', 'BIO', 'MATH', 'ENG', 'SST'],
            '8': ['PHY', 'CHEM', 'BIO', 'MATH', 'ENG', 'SST'],
            '9': ['PHY', 'CHEM', 'BIO', 'MATH', 'ENG', 'SST'],
            '10': ['PHY', 'CHEM', 'BIO', 'MATH', 'ENG', 'SST'],
            '11 JEE': ['PHY', 'CHEM', 'MATH'],
            '11 NEET': ['BOTANY', 'ZOOLOGY', 'PHY', 'CHEM'],
            '12 JEE': ['PHY', 'CHEM', 'MATH'],
            '12 NEET': ['BOTANY', 'ZOOLOGY', 'PHY', 'CHEM']
        };

        // --- DYNAMICALLY CREATE OPTIONS ---
        function renderOptions() {
            optionsContainer.innerHTML = '';
            for (let i = 0; i < 4; i++) {
                const optionHTML = `
                    <div class="option-group">
                        <h4>Option ${i + 1}</h4>
                        <div class="form-group">
                            <label for="option${i}Text">Option Text</label>
                            <input type="text" id="option${i}Text" placeholder="Text for option ${i+1}">
                        </div>
                        <div class="form-group">
                            <label for="option${i}Image">Option Image URL (Optional)</label>
                            <input type="url" id="option${i}Image" placeholder="https://example.com/option${i+1}.png">
                        </div>
                    </div>
                `;
                optionsContainer.innerHTML += optionHTML;
            }
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', renderOptions);

        classSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            subjectSelect.innerHTML = '<option value="">-- Select Subject --</option>';
            subjectSelect.disabled = true;

            if (selectedClass && subjects[selectedClass]) {
                subjects[selectedClass].forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                });
                subjectSelect.disabled = false;
            }
            // Reset and fetch chapters when class changes
            subjectSelect.dispatchEvent(new Event('change'));
        });
        
        subjectSelect.addEventListener('change', fetchChapters);

        existingChapterRadio.addEventListener('change', () => {
            if (existingChapterRadio.checked) {
                existingChapterGroup.classList.remove('hidden');
                newChapterGroup.classList.add('hidden');
                newChapterInput.required = false;
                chapterSelect.required = true;
            }
        });

        newChapterRadio.addEventListener('change', () => {
            if (newChapterRadio.checked) {
                existingChapterGroup.classList.add('hidden');
                newChapterGroup.classList.remove('hidden');
                newChapterInput.required = true;
                chapterSelect.required = false;
            }
        });

        // --- FUNCTIONS ---
        async function fetchChapters() {
            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            chapterSelect.innerHTML = '<option value="">-- Loading Chapters... --</option>';
            
            if (!selectedClass || !selectedSubject) {
                chapterSelect.innerHTML = '<option value="">-- Select Class & Subject --</option>';
                return;
            }

            try {
                const snapshot = await db.collection('questions')
                    .where('class', '==', selectedClass)
                    .where('subject', '==', selectedSubject)
                    .get();

                const chapters = new Set();
                snapshot.forEach(doc => chapters.add(doc.data().chapter));

                chapterSelect.innerHTML = '';
                if (chapters.size === 0) {
                    chapterSelect.innerHTML = '<option value="">-- No chapters found, add a new one --</option>';
                } else {
                    chapters.forEach(chapter => {
                        const option = document.createElement('option');
                        option.value = chapter;
                        option.textContent = chapter;
                        chapterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error fetching chapters: ", error);
                chapterSelect.innerHTML = '<option value="">-- Error loading chapters --</option>';
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Determine chapter
            let chapter;
            if (newChapterRadio.checked) {
                chapter = newChapterInput.value.trim();
            } else {
                chapter = chapterSelect.value;
            }

            if (!chapter) {
                alert("Please select or enter a chapter name.");
                return;
            }
            
            // Gather options data
            const options = [];
            for (let i = 0; i < 4; i++) {
                const text = document.getElementById(`option${i}Text`).value.trim();
                const imageUrl = document.getElementById(`option${i}Image`).value.trim();
                options.push({ text, imageUrl });
            }

            // Construct question object
            const questionData = {
                class: classSelect.value,
                subject: subjectSelect.value,
                chapter: chapter,
                questionText: document.getElementById('questionText').value.trim(),
                questionImageUrl: document.getElementById('questionImage').value.trim(),
                options: options,
                correctAnswerIndex: parseInt(document.getElementById('correctAnswer').value, 10),
                solution: document.getElementById('detailedSolution').value.trim(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Basic Validation
            if (!questionData.questionText && !questionData.questionImageUrl) {
                alert("Question must have either text or an image.");
                return;
            }

            // Save to Firestore
            try {
                await db.collection('questions').add(questionData);
                showStatus('Question saved successfully!', 'success');
                form.reset();
                // Refresh dynamic fields
                subjectSelect.dispatchEvent(new Event('change')); 
            } catch (error) {
                console.error("Error adding document: ", error);
                showStatus('Error saving question. Check console for details.', 'error');
            }
        });

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.classList.remove('hidden');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 5000);
        }

    </script>
</body>
</html>
