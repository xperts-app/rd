<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #2c3e50; }
        #leaderboard-title { font-size: 1.5rem; text-align: center; color: #34495e; margin-bottom: 25px; }
        #loader { text-align: center; font-size: 1.2rem; color: #7f8c8d; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #3498db; color: white; font-weight: 600; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f1f1; }
        td.rank { font-weight: bold; color: #e67e22; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Leaderboard</h1>
        <h2 id="leaderboard-title">Loading...</h2>
        <div id="loader">Fetching results...</div>
        <table id="leaderboard-table" style="display: none;">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Name</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                <!-- Data will be populated here -->
            </tbody>
        </table>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDVIgUAmKlJqwvkd9kblaujzIVlSq9_EiM",
            authDomain: "tests-data-with-leaderboard.firebaseapp.com",
            projectId: "tests-data-with-leaderboard",
            storageBucket: "tests-data-with-leaderboard.firebasestorage.app",
            messagingSenderId: "884648979462",
            appId: "1:884648979462:web:446df6ccb02bf73397e787",
            measurementId: "G-701ZP61XZT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.onload = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const testId = urlParams.get('testid');
            
            if (!testId) {
                document.getElementById('loader').textContent = 'Error: Test ID not provided in URL.';
                return;
            }

            const loader = document.getElementById('loader');
            const table = document.getElementById('leaderboard-table');
            const tableBody = document.getElementById('leaderboard-body');
            const titleEl = document.getElementById('leaderboard-title');

            try {
                // Fetch test name for the title
                const testDoc = await db.collection('tests').doc(testId).get();
                if (testDoc.exists) {
                    titleEl.textContent = `For Test: ${testDoc.data().testName}`;
                } else {
                    titleEl.textContent = 'For an unknown test';
                }

                // Fetch leaderboard data, ordering by score descending
                const querySnapshot = await db.collection('leaderboard')
                                            .where('testId', '==', testId)
                                            .orderBy('score', 'desc')
                                            .get();
                
                loader.style.display = 'none';

                if (querySnapshot.empty) {
                    table.style.display = 'block';
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No results have been submitted for this test yet.</td></tr>';
                    return;
                }
                
                table.style.display = 'table';
                let rank = 1;
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td class="rank">${rank}</td>
                        <td>${data.studentName}</td>
                        <td>${data.score} / ${data.totalQuestions}</td>
                    `;
                    rank++;
                });

            } catch (error) {
                console.error("Error fetching leaderboard: ", error);
                loader.textContent = 'Failed to load leaderboard. Check console for details.';
            }
        };
    </script>
</body>
</html>
