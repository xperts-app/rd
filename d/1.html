<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Docin — Files</title>
<style>
  :root{--accent:#1b6ef6;--bg:#f3f6fb;--card:#fff;--muted:#6b7280}
  body{font-family:Inter, system-ui, Arial, sans-serif;margin:0;background:var(--bg);color:#111}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#fff;border-bottom:1px solid #e6e9ef}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:6px;background:linear-gradient(135deg,var(--accent),#5ec0ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .container{max-width:980px;margin:28px auto;padding:0 16px}
  .controls{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  button, .btn {background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .btn.secondary{background:#fff;color:var(--accent);border:1px solid #dfe7fb}
  .file-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 1px 0 rgba(0,0,0,0.03);border:1px solid #eef2ff;display:flex;flex-direction:column;gap:8px}
  .fname{font-weight:600}
  .meta{font-size:12px;color:var(--muted)}
  .card .actions{margin-top:auto;display:flex;gap:6px}
  a.open-link{flex:1;text-decoration:none}
  input.search{padding:8px;border-radius:8px;border:1px solid #dde7f9}
  .small{font-size:13px;color:var(--muted)}
  footer{max-width:980px;margin:18px auto;padding:12px 16px;color:var(--muted);font-size:13px}
  label.file-import{display:inline-block;padding:8px 10px;border-radius:8px;background:#fff;border:1px dashed #cddbf8;color:var(--accent);cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">Di</div>
    <div>
      <div style="font-weight:700">Docin</div>
      <div style="font-size:13px;color:var(--muted)">Local .docin editor</div>
    </div>
  </div>
  <div>
    <button id="newBtn">+ New</button>
    <label class="file-import" title="Import .docin file">
      Import <input id="importFile" type="file" accept=".docin" style="display:none"/>
    </label>
  </div>
</header>

<div class="container">
  <div class="controls">
    <input id="search" class="search" placeholder="Search files..." />
    <div style="flex:1"></div>
    <button class="btn secondary" id="downloadAll">Download all</button>
  </div>

  <div id="emptyMessage" style="padding:18px;background:#fff;border-radius:8px;display:none">
    <div style="font-weight:700">No documents yet</div>
    <div class="small">Click <strong>New</strong> to create a document — it will open in the editor.</div>
  </div>

  <div id="list" class="file-list" aria-live="polite"></div>
</div>

<footer>Files are saved locally in your browser. Export/import uses encrypted <code>.docin</code> files.</footer>

<script>
/* ===== Encryption helpers ===== */
const ENC_KEY_STRING = 'docin_secret_key_2025';
let ENC_KEY_OBJ = null;
function strToUint8(str){ return new TextEncoder().encode(str); }
function uint8ToStr(buf){ return new TextDecoder().decode(buf); }
function bytesToBase64(bytes){ let bin=''; bytes.forEach(b=>bin+=String.fromCharCode(b)); return btoa(bin);}
function base64ToBytes(base64){ let bin=atob(base64); let bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return bytes;}
async function getKey(){ if(ENC_KEY_OBJ) return ENC_KEY_OBJ; ENC_KEY_OBJ=await crypto.subtle.importKey('raw',strToUint8(ENC_KEY_STRING.padEnd(32,' ')).slice(0,32),{name:'AES-GCM'},false,['encrypt','decrypt']); return ENC_KEY_OBJ;}
async function encryptString(plain){ const key=await getKey(); const iv=crypto.getRandomValues(new Uint8Array(12)); const enc=await crypto.subtle.encrypt({name:'AES-GCM',iv},key,strToUint8(plain)); const encBytes=new Uint8Array(enc); const full=new Uint8Array(iv.length+encBytes.length); full.set(iv,0); full.set(encBytes,iv.length); return bytesToBase64(full);}
async function decryptString(b64){ const key=await getKey(); const full=base64ToBytes(b64); const iv=full.slice(0,12); const data=full.slice(12); const dec=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,data); return uint8ToStr(new Uint8Array(dec)); }

/* ===== Storage helpers ===== */
const STORAGE_KEY = 'docin_files_v1';
function loadAll(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}') }catch(e){return{}}}
function saveAll(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
function makeId(){ return 'd_' + Date.now() + '_' + Math.random().toString(36).slice(2,9); }
function nowIso(){ return new Date().toISOString(); }
function sanitizeHTML(html){ const p=new DOMParser(); const d=p.parseFromString(html,'text/html'); d.querySelectorAll('script').forEach(n=>n.remove()); [...d.querySelectorAll('*')].forEach(el=>{for(const a of [...el.attributes]) if(a.name.startsWith('on')) el.removeAttribute(a.name)}); return d.body.innerHTML; }

/* ===== UI logic ===== */
const listEl=document.getElementById('list'); const emptyMessage=document.getElementById('emptyMessage'); const search=document.getElementById('search');
function renderList(filter=''){ const files=loadAll(); const arr=Object.values(files).sort((a,b)=>b.modified.localeCompare(a.modified)); const shown=arr.filter(f=>f.name.toLowerCase().includes(filter.toLowerCase())); listEl.innerHTML=''; emptyMessage.style.display= shown.length===0 && arr.length===0 ? 'block':'none';
shown.forEach(file=>{ const card=document.createElement('div'); card.className='card'; const name=document.createElement('div'); name.className='fname'; name.textContent=file.name; const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`Modified ${new Date(file.modified).toLocaleString()}`; const excerpt=document.createElement('div'); excerpt.className='small'; excerpt.innerHTML=(file.content ? file.content.replace(/(<[^>]*>)/g,'').slice(0,140) : '<i>Empty</i>'); const actions=document.createElement('div'); actions.className='actions';
const openLink=document.createElement('a'); openLink.className='open-link'; openLink.href=`2.html?id=${encodeURIComponent(file.id)}`; openLink.textContent='Open';
const download=document.createElement('button'); download.textContent='Download'; download.className='btn secondary'; download.onclick=()=>downloadDocin(file);
const rename=document.createElement('button'); rename.textContent='Rename'; rename.className='btn secondary'; rename.onclick=()=>{ const v=prompt('Rename file', file.name); if(v&&v.trim()){ const all=loadAll(); all[file.id].name=v.trim(); all[file.id].modified=nowIso(); saveAll(all); renderList(search.value);} };
const del=document.createElement('button'); del.textContent='Delete'; del.className='btn'; del.style.background='#ef4444'; del.onclick=()=>{ if(!confirm('Delete "'+file.name+'"?')) return; const all=loadAll(); delete all[file.id]; saveAll(all); renderList(search.value); };
actions.append(openLink,download,rename,del); card.append(name,meta,excerpt,actions); listEl.append(card); }); }

async function downloadDocin(file){ const payload={version:1,id:file.id,name:file.name,modified:file.modified,content:file.content}; const encData=await encryptString(JSON.stringify(payload)); const blob=new Blob([encData],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=file.name.endsWith('.docin')?file.name:file.name+'.docin'; document.body.appendChild(a); a.click(); a.remove(); }

/* ===== Events ===== */
document.getElementById('newBtn').onclick=()=>{ const all=loadAll(); const id=makeId(); all[id]={id,name:'Untitled.docin',content:'<p></p>',modified:nowIso()}; saveAll(all); location.href=`2.html?id=${encodeURIComponent(id)}`; };
document.getElementById('importFile').addEventListener('change',async(e)=>{ const f=e.target.files[0]; if(!f) return; const txt=await f.text(); try{ const decrypted=await decryptString(txt); const parsed=JSON.parse(decrypted); if(!parsed.content||!parsed.name) throw new Error('Invalid file'); const all=loadAll(); const id=makeId(); all[id]={id,name:parsed.name,content:sanitizeHTML(parsed.content),modified:parsed.modified||nowIso()}; saveAll(all); renderList(search.value); alert('Imported '+parsed.name); }catch(err){ alert('Could not import: '+err.message); } e.target.value=''; });
document.getElementById('downloadAll').onclick=()=>{ const all=loadAll(); if(!Object.keys(all).length) return alert('No files.'); Object.values(all).forEach(f=>downloadDocin(f)); };
search.oninput=()=>renderList(search.value);

/* ===== Init ===== */
renderList('');
</script>
</body>
</html>
