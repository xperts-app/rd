<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Add Question</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { color: #d93025; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #5f6368; }
        input[type="text"], input[type="url"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
        }
        textarea { resize: vertical; min-height: 100px; }
        .radio-group label { display: inline-block; margin-right: 15px; }
        .option-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px;}
        .option-group input[type="radio"] { width: auto; }
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            background-color: #d93025;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #a52714; }
        .hidden { display: none; }
        #status-message { margin-top: 20px; font-weight: bold; padding: 10px; border-radius: 5px; }
        .success { background-color: #e6f4ea; color: #1e8e3e; }
        .error { background-color: #fce8e6; color: #d93025; }
    </style>
</head>
<body>

<div class="container">
    <h1>Admin: Add New Question</h1>
    <form id="question-form">
        <!-- Class and Subject -->
        <div class="form-group">
            <label for="class-select">Class</label>
            <select id="class-select" required>
                <option value="" disabled selected>-- Choose a Class --</option>
                <option value="6">Class 6</option>
                <option value="7">Class 7</option>
                <option value="8">Class 8</option>
                <option value="9">Class 9</option>
                <option value="10">Class 10</option>
                <option value="11-JEE">Class 11 (JEE)</option>
                <option value="11-NEET">Class 11 (NEET)</option>
                <option value="12-JEE">Class 12 (JEE)</option>
                <option value="12-NEET">Class 12 (NEET)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="subject-select">Subject</label>
            <select id="subject-select" required>
                <option value="" disabled selected>-- Select Class First --</option>
            </select>
        </div>

        <!-- Chapter -->
        <div class="form-group">
            <label for="chapter-select">Chapter (Select Existing or Add New)</label>
            <select id="chapter-select">
                <option value="">-- Select Existing Chapter --</option>
            </select>
            <input type="text" id="new-chapter-input" placeholder="Or, type a new chapter name here">
        </div>

        <!-- Question Type -->
        <div class="form-group">
            <label>Question is:</label>
            <div class="radio-group">
                <label><input type="radio" name="question-type" value="text" checked> Text</label>
                <label><input type="radio" name="question-type" value="image"> Image</label>
            </div>
        </div>
        <div class="form-group" id="question-text-group">
            <label for="question-text">Question Text</label>
            <textarea id="question-text" rows="4"></textarea>
        </div>
        <div class="form-group hidden" id="question-image-group">
            <label for="question-image-url">Question Image URL</label>
            <input type="url" id="question-image-url" placeholder="https://example.com/image.png">
        </div>

        <!-- Options -->
        <div class="form-group">
            <label>Options are:</label>
            <div class="radio-group">
                <label><input type="radio" name="option-type" value="text" checked> Text</label>
                <label><input type="radio" name="option-type" value="image"> Image</label>
            </div>
        </div>
        <div id="options-container">
            <!-- Options will be generated here -->
        </div>

        <!-- Correct Answer -->
        <div class="form-group">
            <label>Correct Answer</label>
            <select id="correct-answer-select" required>
                <option value="0">Option A</option>
                <option value="1">Option B</option>
                <option value="2">Option C</option>
                <option value="3">Option D</option>
            </select>
        </div>
        
        <!-- Solution -->
        <div class="form-group">
            <label for="detailed-solution">Detailed Solution</label>
            <textarea id="detailed-solution" rows="4"></textarea>
        </div>

        <button type="submit">Save Question</button>
        <div id="status-message"></div>
    </form>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

<script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyBrdCOyTrQ_uU4jID8hWzCQzaXilhAcGcs",
        authDomain: "custom-practices.firebaseapp.com",
        projectId: "custom-practices",
        storageBucket: "custom-practices.firebasestorage.app",
        messagingSenderId: "636700937539",
        appId: "1:636700937539:web:d6ec9d88453e15481d33f6",
        measurementId: "G-JL58DMTZ0W"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM Elements
    const classSelect = document.getElementById('class-select');
    const subjectSelect = document.getElementById('subject-select');
    const chapterSelect = document.getElementById('chapter-select');
    const newChapterInput = document.getElementById('new-chapter-input');
    const questionForm = document.getElementById('question-form');
    const statusMessage = document.getElementById('status-message');

    const subjectsMap = {
        '6-10': ['Physics', 'Chemistry', 'Math', 'English', 'Social Science', 'Biology'],
        'JEE': ['Math', 'Physics', 'Chemistry'],
        'NEET': ['Botany', 'Physics', 'Zoology', 'Chemistry']
    };

    // Dynamic Subject Dropdown
    classSelect.addEventListener('change', () => {
        const selectedClass = classSelect.value;
        subjectSelect.innerHTML = '<option value="" disabled selected>-- Choose a Subject --</option>';
        chapterSelect.innerHTML = '<option value="">-- Select Existing Chapter --</option>';
        newChapterInput.value = '';

        let subjectList = [];
        if (['6', '7', '8', '9', '10'].includes(selectedClass)) {
            subjectList = subjectsMap['6-10'];
        } else if (selectedClass.includes('JEE')) {
            subjectList = subjectsMap['JEE'];
        } else if (selectedClass.includes('NEET')) {
            subjectList = subjectsMap['NEET'];
        }

        subjectList.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelect.appendChild(option);
        });
    });

    // Dynamic Chapter Dropdown
    async function loadChapters() {
        const selectedClass = classSelect.value;
        const selectedSubject = subjectSelect.value;
        
        if (!selectedClass || !selectedSubject) return;

        chapterSelect.innerHTML = '<option value="">-- Loading Chapters... --</option>';
        
        try {
            const querySnapshot = await db.collection('questions')
                .where('class', '==', selectedClass)
                .where('subject', '==', selectedSubject)
                .get();
            
            const chapters = new Set();
            querySnapshot.forEach(doc => {
                chapters.add(doc.data().chapter);
            });
            
            chapterSelect.innerHTML = '<option value="">-- Select Existing Chapter --</option>';
            chapters.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter;
                option.textContent = chapter;
                chapterSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Error loading chapters: ", error);
            chapterSelect.innerHTML = '<option value="">-- Error Loading --</option>';
        }
    }

    subjectSelect.addEventListener('change', loadChapters);

    // Toggle Question Type
    document.querySelectorAll('input[name="question-type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            const isImage = e.target.value === 'image';
            document.getElementById('question-text-group').classList.toggle('hidden', isImage);
            document.getElementById('question-image-group').classList.toggle('hidden', !isImage);
        });
    });

    // Toggle Option Type and Render Options
    const optionsContainer = document.getElementById('options-container');
    function renderOptions(type = 'text') {
        optionsContainer.innerHTML = '';
        const optionLabels = ['A', 'B', 'C', 'D'];
        for (let i = 0; i < 4; i++) {
            const div = document.createElement('div');
            div.className = 'form-group';
            if (type === 'text') {
                div.innerHTML = `
                    <label for="option-text-${i}">Option ${optionLabels[i]}</label>
                    <textarea id="option-text-${i}" rows="2" class="option-input"></textarea>
                `;
            } else { // image
                div.innerHTML = `
                    <label for="option-image-${i}">Option ${optionLabels[i]} Image URL</label>
                    <input type="url" id="option-image-${i}" class="option-input" placeholder="https://example.com/option${i}.png">
                `;
            }
            optionsContainer.appendChild(div);
        }
    }
    
    document.querySelectorAll('input[name="option-type"]').forEach(radio => {
        radio.addEventListener('change', (e) => renderOptions(e.target.value));
    });

    // Initial render
    renderOptions();

    // Form Submission
    questionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusMessage.textContent = 'Saving...';
        statusMessage.className = 'status-message';
        
        try {
            // 1. Get Chapter
            let chapter = newChapterInput.value.trim() || chapterSelect.value;
            if (!chapter) {
                throw new Error("Chapter is required. Please select an existing one or add a new one.");
            }

            // 2. Get Question
            const questionType = document.querySelector('input[name="question-type"]:checked').value;
            const question = {
                type: questionType,
                text: questionType === 'text' ? document.getElementById('question-text').value : '',
                imageUrl: questionType === 'image' ? document.getElementById('question-image-url').value : ''
            };

            // 3. Get Options
            const optionType = document.querySelector('input[name="option-type"]:checked').value;
            const options = [];
            document.querySelectorAll('.option-input').forEach(input => {
                options.push(input.value);
            });

            // 4. Construct data object
            const questionData = {
                class: classSelect.value,
                subject: subjectSelect.value,
                chapter: chapter,
                question: question,
                options: {
                    type: optionType,
                    data: options
                },
                correctAnswer: parseInt(document.getElementById('correct-answer-select').value, 10),
                solution: document.getElementById('detailed-solution').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // 5. Validate
             if (!questionData.class || !questionData.subject || !questionData.chapter) {
                throw new Error("Class, Subject, and Chapter must be selected.");
            }
            if ((question.type === 'text' && !question.text) || (question.type === 'image' && !question.imageUrl)) {
                throw new Error("Question content is missing.");
            }
            if(questionData.options.data.some(opt => !opt.trim())) {
                throw new Error("All four options must be filled out.");
            }

            // 6. Save to Firestore
            await db.collection('questions').add(questionData);
            
            statusMessage.textContent = 'Question saved successfully!';
            statusMessage.className = 'status-message success';
            questionForm.reset();
            // Reset dynamic fields manually
            subjectSelect.innerHTML = '<option value="" disabled selected>-- Select Class First --</option>';
            chapterSelect.innerHTML = '<option value="">-- Select Existing Chapter --</option>';
            renderOptions();


        } catch (error) {
            console.error("Error saving question: ", error);
            statusMessage.textContent = `Error: ${error.message}`;
            statusMessage.className = 'status-message error';
        }
    });
</script>

</body>
</html>
