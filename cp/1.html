<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Add Question</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        h1 { color: #4A90E2; text-align: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; }
        input[type="text"], input[type="url"], select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        textarea { min-height: 100px; resize: vertical; }
        button {
            background-color: #4A90E2;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #357ABD; }
        .radio-group label { display: inline-block; margin-right: 15px; }
        .option-group { border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; margin-bottom: 10px; }
        #newChapterGroup { display: none; margin-top: 10px; }
        #status { text-align: center; font-weight: bold; margin-top: 20px; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    <h1>Add a New Question</h1>
    <form id="questionForm">
        <!-- Class and Subject -->
        <div class="form-group">
            <label for="classSelect">Class</label>
            <select id="classSelect" required>
                <option value="">-- Select a Class --</option>
            </select>
        </div>
        <div class="form-group">
            <label for="subjectSelect">Subject</label>
            <select id="subjectSelect" required>
                <option value="">-- Select a Subject --</option>
            </select>
        </div>

        <!-- Chapter -->
        <div class="form-group">
            <label for="chapterSelect">Chapter</label>
            <select id="chapterSelect" required>
                <option value="">-- Select or Add Chapter --</option>
            </select>
            <div id="newChapterGroup">
                <label for="newChapterInput">New Chapter Name:</label>
                <input type="text" id="newChapterInput" placeholder="e.g., Kinematics">
            </div>
        </div>

        <!-- Question -->
        <div class="form-group">
            <label>Question Type</label>
            <div class="radio-group">
                <label><input type="radio" name="questionType" value="text" checked> Text</label>
                <label><input type="radio" name="questionType" value="image"> Image</label>
            </div>
            <textarea id="questionText" placeholder="Enter the question text here..."></textarea>
            <input type="url" id="questionImage" placeholder="Enter image URL..." style="display:none;">
        </div>

        <!-- Options -->
        <div class="form-group" id="optionsContainer">
            <label>Options</label>
            <!-- Options will be added dynamically here -->
        </div>
        <button type="button" id="addOptionBtn" style="width: auto; padding: 8px 15px; margin-bottom: 20px; background-color: #6c757d;">+ Add Option</button>

        <!-- Correct Answer -->
        <div class="form-group">
            <label for="correctAnswerSelect">Correct Answer</label>
            <select id="correctAnswerSelect" required>
                <option value="">-- Select Correct Option --</option>
            </select>
        </div>

        <!-- Solution -->
         <div class="form-group">
            <label>Solution Type</label>
            <div class="radio-group">
                <label><input type="radio" name="solutionType" value="text" checked> Text</label>
                <label><input type="radio" name="solutionType" value="image"> Image</label>
            </div>
            <textarea id="solutionText" placeholder="Enter the detailed solution here..."></textarea>
            <input type="url" id="solutionImage" placeholder="Enter solution image URL..." style="display:none;">
        </div>

        <button type="submit">Save Question</button>
    </form>
    <div id="status"></div>
</div>


<script>
    // IMPORTANT: Replace with your actual Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY", // Replace this
      authDomain: "custom-practices.firebaseapp.com",
      projectId: "custom-practices",
      databaseURL: "https://custom-practices-default-rtdb.firebaseio.com", // Make sure this is correct
      storageBucket: "custom-practices.firebasestorage.app",
      messagingSenderId: "636700937539",
      appId: "1:636700937539:web:d6ec9d88453e15481d33f6"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const classSubjectMap = {
        'class_6': { name: 'Class 6', subjects: ['Physics', 'Chemistry', 'Math', 'English', 'Social Science', 'Biology'] },
        'class_7': { name: 'Class 7', subjects: ['Physics', 'Chemistry', 'Math', 'English', 'Social Science', 'Biology'] },
        'class_8': { name: 'Class 8', subjects: ['Physics', 'Chemistry', 'Math', 'English', 'Social Science', 'Biology'] },
        'class_9': { name: 'Class 9', subjects: ['Physics', 'Chemistry', 'Math', 'English', 'Social Science', 'Biology'] },
        'class_10': { name: 'Class 10', subjects: ['Physics', 'Chemistry', 'Math', 'English', 'Social Science', 'Biology'] },
        'class_11_JEE': { name: '11 JEE', subjects: ['Math', 'Physics', 'Chemistry'] },
        'class_11_NEET': { name: '11 NEET', subjects: ['Botany', 'Physics', 'Zoology', 'Chemistry'] },
        'class_12_JEE': { name: '12 JEE', subjects: ['Math', 'Physics', 'Chemistry'] },
        'class_12_NEET': { name: '12 NEET', subjects: ['Botany', 'Physics', 'Zoology', 'Chemistry'] }
    };
    
    // DOM Elements
    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const newChapterGroup = document.getElementById('newChapterGroup');
    const newChapterInput = document.getElementById('newChapterInput');
    const optionsContainer = document.getElementById('optionsContainer');
    const addOptionBtn = document.getElementById('addOptionBtn');
    const correctAnswerSelect = document.getElementById('correctAnswerSelect');
    const form = document.getElementById('questionForm');
    const statusDiv = document.getElementById('status');
    
    // Populate Class Select
    for (const key in classSubjectMap) {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = classSubjectMap[key].name;
        classSelect.appendChild(option);
    }

    // Event Listeners
    classSelect.addEventListener('change', (e) => {
        const classKey = e.target.value;
        subjectSelect.innerHTML = '<option value="">-- Select a Subject --</option>';
        chapterSelect.innerHTML = '<option value="">-- Select or Add Chapter --</option>';
        if (classKey) {
            const subjects = classSubjectMap[classKey].subjects;
            subjects.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subjectSelect.appendChild(option);
            });
        }
    });

    subjectSelect.addEventListener('change', (e) => {
        const classKey = classSelect.value;
        const subject = e.target.value;
        chapterSelect.innerHTML = '<option value="">-- Loading Chapters... --</option>';
        if (classKey && subject) {
            fetchChapters(classKey, subject);
        }
    });

    chapterSelect.addEventListener('change', (e) => {
        if (e.target.value === 'add_new') {
            newChapterGroup.style.display = 'block';
            newChapterInput.required = true;
        } else {
            newChapterGroup.style.display = 'none';
            newChapterInput.required = false;
        }
    });

    document.querySelectorAll('input[name="questionType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            document.getElementById('questionText').style.display = (e.target.value === 'text') ? 'block' : 'none';
            document.getElementById('questionImage').style.display = (e.target.value === 'image') ? 'block' : 'none';
        });
    });

    document.querySelectorAll('input[name="solutionType"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            document.getElementById('solutionText').style.display = (e.target.value === 'text') ? 'block' : 'none';
            document.getElementById('solutionImage').style.display = (e.target.value === 'image') ? 'block' : 'none';
        });
    });

    addOptionBtn.addEventListener('click', () => {
        const optionIndex = optionsContainer.children.length;
        createOptionInput(optionIndex);
        updateCorrectAnswerSelect();
    });

    form.addEventListener('submit', saveQuestion);

    // Functions
    function fetchChapters(classKey, subject) {
        const chapterRef = database.ref(`chapters/${classKey}/${subject}`);
        chapterRef.once('value', (snapshot) => {
            chapterSelect.innerHTML = '<option value="">-- Select a Chapter --</option>';
            const chapters = snapshot.val();
            if (chapters) {
                chapters.forEach(chap => {
                    const option = document.createElement('option');
                    option.value = chap;
                    option.textContent = chap;
                    chapterSelect.appendChild(option);
                });
            }
            const addNewOption = document.createElement('option');
            addNewOption.value = 'add_new';
            addNewOption.textContent = '-- Add a New Chapter --';
            chapterSelect.appendChild(addNewOption);
        });
    }
    
    function createOptionInput(index) {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option-group';
        optionDiv.innerHTML = `
            <strong>Option ${index + 1}</strong>
            <div class="radio-group">
                <label><input type="radio" name="optionType_${index}" value="text" checked> Text</label>
                <label><input type="radio" name="optionType_${index}" value="image"> Image</label>
            </div>
            <textarea class="option-text" placeholder="Option ${index + 1} text"></textarea>
            <input type="url" class="option-image" placeholder="Option ${index + 1} image URL" style="display:none;">
        `;
        optionsContainer.appendChild(optionDiv);

        optionDiv.querySelectorAll(`input[name="optionType_${index}"]`).forEach(radio => {
            radio.addEventListener('change', (e) => {
                optionDiv.querySelector('.option-text').style.display = (e.target.value === 'text') ? 'block' : 'none';
                optionDiv.querySelector('.option-image').style.display = (e.target.value === 'image') ? 'block' : 'none';
            });
        });
    }

    function updateCorrectAnswerSelect() {
        correctAnswerSelect.innerHTML = '<option value="">-- Select Correct Option --</option>';
        const optionCount = optionsContainer.children.length;
        for (let i = 0; i < optionCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Option ${i + 1}`;
            correctAnswerSelect.appendChild(option);
        }
    }

    async function saveQuestion(e) {
        e.preventDefault();
        statusDiv.textContent = 'Saving...';
        statusDiv.className = '';

        try {
            const classKey = classSelect.value;
            const subject = subjectSelect.value;
            let chapter = chapterSelect.value;

            // Handle new chapter
            if (chapter === 'add_new') {
                chapter = newChapterInput.value.trim();
                if (!chapter) throw new Error("New chapter name cannot be empty.");
                // Save new chapter to the chapters list
                const chapterRef = database.ref(`chapters/${classKey}/${subject}`);
                const snapshot = await chapterRef.once('value');
                const chapters = snapshot.val() || [];
                if (!chapters.includes(chapter)) {
                    chapters.push(chapter);
                    await chapterRef.set(chapters);
                }
            }

            // Construct question object
            const questionData = {
                questionType: document.querySelector('input[name="questionType"]:checked').value,
                questionText: document.getElementById('questionText').value,
                questionImage: document.getElementById('questionImage').value,
                options: [],
                correctAnswerIndex: parseInt(correctAnswerSelect.value),
                solutionType: document.querySelector('input[name="solutionType"]:checked').value,
                solutionText: document.getElementById('solutionText').value,
                solutionImage: document.getElementById('solutionImage').value,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            const optionElements = optionsContainer.children;
            for (let i = 0; i < optionElements.length; i++) {
                const optionType = optionElements[i].querySelector(`input[name="optionType_${i}"]:checked`).value;
                const option = {
                    type: optionType,
                    text: (optionType === 'text') ? optionElements[i].querySelector('.option-text').value : '',
                    image: (optionType === 'image') ? optionElements[i].querySelector('.option-image').value : ''
                };
                questionData.options.push(option);
            }

            // Validate
            if (!classKey || !subject || !chapter || correctAnswerSelect.value === '') throw new Error("Please fill all required fields.");

            // Save to Firebase
            const questionListRef = database.ref(`questions/${classKey}/${subject}/${chapter}`);
            await questionListRef.push(questionData);
            
            statusDiv.textContent = 'Question saved successfully!';
            statusDiv.className = 'success';
            form.reset();
            // Reset dynamic fields
            optionsContainer.innerHTML = '';
            createOptionInput(0);
            createOptionInput(1);
            createOptionInput(2);
            createOptionInput(3);
            updateCorrectAnswerSelect();

        } catch (error) {
            console.error("Error saving question:", error);
            statusDiv.textContent = `Error: ${error.message}`;
            statusDiv.className = 'error';
        }
    }

    // Initialize with 4 option fields
    createOptionInput(0);
    createOptionInput(1);
    createOptionInput(2);
    createOptionInput(3);
    updateCorrectAnswerSelect();

</script>
</body>
</html>
