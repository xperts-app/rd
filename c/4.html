<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Content Library (Firestore)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #0056b3; text-align: center; margin-bottom: 30px; }
        .panel { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #libraryContainer { min-height: 200px; }
        .class-block { margin-bottom: 25px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .class-header { background-color: #0056b3; color: white; padding: 15px 20px; }
        .class-header h2 { margin: 0; font-size: 1.5em; }
        .class-content { padding: 20px; }
        .subject-block { margin-bottom: 20px; border-left: 3px solid #007bff; padding-left: 15px; }
        .chapter-card { background-color: #fdfdff; border: 1px solid #eef; border-radius: 6px; padding: 15px; margin-bottom: 15px; }
        h3, h4 { color: #333; }
        h3 { margin-top: 0; }
        .content-type-header { font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #555; }
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 5px; }
        li a { text-decoration: none; color: #007bff; }
        li a:hover { text-decoration: underline; }
        #loader { text-align: center; font-size: 1.2em; padding: 40px; }
        .error-message { color: #721c24; background-color: #f8d7da; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Full Content Library</h1>
        <div class="panel">
            <div id="libraryContainer">
                <div id="loader">Loading content library...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyALyD306KRV3o4BF6JddkvESPRroU7ljDE",
          authDomain: "study-books-45192.firebaseapp.com",
          projectId: "study-books-45192",
          storageBucket: "study-books-45192.firebasestorage.app",
          messagingSenderId: "339305499523",
          appId: "1:339305499523:web:c51eaccbdaebe1293004b6",
          measurementId: "G-MZWBP5RR9Z"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function loadContentLibrary() {
            const libraryContainer = document.getElementById('libraryContainer');
            const loader = document.getElementById('loader');
            loader.style.display = 'block';

            db.collection('content')
              .orderBy('class')
              .orderBy('subject')
              .orderBy('createdAt', 'desc')
              .get()
              .then(querySnapshot => {
                    loader.style.display = 'none';
                    if (querySnapshot.empty) {
                        libraryContainer.innerHTML = '<p>No content has been added to the library yet.</p>';
                        return;
                    }

                    const library = {};
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if (!library[data.class]) library[data.class] = {};
                        if (!library[data.class][data.subject]) library[data.class][data.subject] = {};
                        if (!library[data.class][data.subject][data.chapter]) {
                            library[data.class][data.subject][data.chapter] = { videos: [], pdfs: [] };
                        }
                        if (data.contentType === 'video') {
                            library[data.class][data.subject][data.chapter].videos.push(data);
                        } else if (data.contentType === 'pdf') {
                            library[data.class][data.subject][data.chapter].pdfs.push(data);
                        }
                    });

                    renderLibrary(library);
              })
              .catch(error => {
                  loader.style.display = 'none';
                  libraryContainer.innerHTML = `<div class="error-message">
                        <strong>An error occurred while loading the library.</strong><br>
                        ${error.message}<br><br>
                        Please check the browser's developer console (F12) for a link to create the necessary Firestore index.
                        </div>`;
                  console.error("Error loading library: ", error);
              });
        }

        function renderLibrary(library) {
            const libraryContainer = document.getElementById('libraryContainer');
            let html = '';

            for (const className in library) {
                html += `<div class="class-block"><div class="class-header"><h2>Class: ${className}</h2></div><div class="class-content">`;
                const subjects = library[className];
                for (const subjectName in subjects) {
                    html += `<div class="subject-block"><h3>Subject: ${subjectName}</h3>`;
                    const chapters = subjects[subjectName];
                    for (const chapterName in chapters) {
                        html += `<div class="chapter-card"><h4>${chapterName}</h4>`;
                        const chapterData = chapters[chapterName];
                        if (chapterData.videos.length > 0) {
                            html += `<div class="content-type-header">Videos</div><ul>`;
                            chapterData.videos.forEach(v => html += `<li><a href="${v.url}" target="_blank">${v.title}</a></li>`);
                            html += `</ul>`;
                        }
                        if (chapterData.pdfs.length > 0) {
                            html += `<div class="content-type-header">PDFs</div><ul>`;
                            chapterData.pdfs.forEach(p => html += `<li><a href="${p.url}" target="_blank">${p.title}</a></li>`);
                            html += `</ul>`;
                        }
                        html += `</div>`;
                    }
                    html += `</div>`;
                }
                html += `</div></div>`;
            }
            libraryContainer.innerHTML = html;
        }

        document.addEventListener('DOMContentLoaded', loadContentLibrary);
    </script>
</body>
</html>
