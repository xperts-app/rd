<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Manage Content</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #0056b3; text-align: center; margin-bottom: 30px; }
        .panel { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        /* Search Bar */
        .search-container { margin-bottom: 20px; }
        #searchInput { width: 100%; padding: 12px 15px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; }

        /* Library Styles */
        #libraryContainer { min-height: 200px; }
        .class-block { margin-bottom: 25px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .class-header { background-color: #0056b3; color: white; padding: 15px 20px; }
        .class-header h2 { margin: 0; font-size: 1.5em; }
        .class-content { padding: 20px; }
        .subject-block { margin-bottom: 20px; border-left: 3px solid #007bff; padding-left: 15px; }
        .chapter-card { background-color: #fdfdff; border: 1px solid #eef; border-radius: 6px; padding: 15px; margin-bottom: 15px; }
        h3, h4 { color: #333; }
        h3 { margin-top: 0; }
        .content-type-header { font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #555; }
        ul { list-style-type: none; padding-left: 0; }
        
        /* List Item with Actions */
        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        li:last-child { border-bottom: none; }
        li a { text-decoration: none; color: #007bff; flex-grow: 1; }
        li a:hover { text-decoration: underline; }
        .actions { display: flex; gap: 15px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; }
        .edit-btn { color: #ffa000; }
        .delete-btn { color: #d32f2f; }
        .action-btn:hover { opacity: 0.7; }

        /* Loader & Messages */
        #loader { text-align: center; font-size: 1.2em; padding: 40px; }
        .error-message { color: #721c24; background-color: #f8d7da; padding: 15px; border-radius: 5px; }

        /* Edit Modal Styles */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        }
        .modal-content h2 { margin-top: 0; color: #0056b3; }
        .modal-form-group { margin-bottom: 20px; }
        .modal-form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .modal-form-group input { width: 100%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-actions button {
            padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;
        }
        #save-edit-btn { background-color: #28a745; color: white; }
        #cancel-edit-btn { background-color: #6c757d; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Content Management Dashboard</h1>
        <div class="panel">
            <div class="search-container">
                <input type="search" id="searchInput" placeholder="Search for chapters or content titles...">
            </div>
            <div id="libraryContainer">
                <div id="loader">Loading content library...</div>
            </div>
        </div>
    </div>

    <!-- Edit Modal HTML -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <h2>Edit Content</h2>
            <form id="editForm">
                <input type="hidden" id="editDocId">
                <div class="modal-form-group">
                    <label for="editTitle">Title</label>
                    <input type="text" id="editTitle" required>
                </div>
                <div class="modal-form-group">
                    <label for="editUrl">URL</label>
                    <input type="url" id="editUrl" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-edit-btn">Cancel</button>
                    <button type="submit" id="save-edit-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyALyD306KRV3o4BF6JddkvESPRroU7ljDE",
          authDomain: "study-books-45192.firebaseapp.com",
          projectId: "study-books-45192",
          storageBucket: "study-books-45192.firebasestorage.app",
          messagingSenderId: "339305499523",
          appId: "1:339305499523:web:c51eaccbdaebe1293004b6",
          measurementId: "G-MZWBP5RR9Z"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let fullLibraryData = {}; // Global variable to hold all data for searching
        
        const libraryContainer = document.getElementById('libraryContainer');
        const searchInput = document.getElementById('searchInput');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        
        async function loadContentLibrary() {
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            libraryContainer.innerHTML = '';
            libraryContainer.appendChild(loader);

            try {
                const querySnapshot = await db.collection('content')
                    .orderBy('class').orderBy('subject').orderBy('createdAt', 'desc')
                    .get();
                
                if (querySnapshot.empty) {
                    libraryContainer.innerHTML = '<p>No content has been added to the library yet.</p>';
                    return;
                }

                // Group all content by class -> subject -> chapter
                const library = {};
                querySnapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() }; // Include document ID
                    if (!library[data.class]) library[data.class] = {};
                    if (!library[data.class][data.subject]) library[data.class][data.subject] = {};
                    if (!library[data.class][data.subject][data.chapter]) {
                        library[data.class][data.subject][data.chapter] = { videos: [], pdfs: [] };
                    }
                    if (data.contentType === 'video') library[data.class][data.subject][data.chapter].videos.push(data);
                    else if (data.contentType === 'pdf') library[data.class][data.subject][data.chapter].pdfs.push(data);
                });

                fullLibraryData = library; // Store for searching
                renderLibrary(fullLibraryData); // Initial render
            } catch (error) {
                loader.style.display = 'none';
                libraryContainer.innerHTML = `<div class="error-message"><strong>Error loading library:</strong> ${error.message}</div>`;
                console.error("Error loading library: ", error);
            }
        }

        function renderLibrary(library, searchTerm = '') {
            let html = '';
            const lowerCaseSearchTerm = searchTerm.toLowerCase();

            for (const className in library) {
                let classContent = '';
                for (const subjectName in library[className]) {
                    let subjectContent = '';
                    for (const chapterName in library[className][subjectName]) {
                        const chapterData = library[className][subjectName][chapterName];
                        let videoList = '';
                        let pdfList = '';
                        let chapterHasContent = false;

                        // Filter videos
                        chapterData.videos.forEach(v => {
                            if (!searchTerm || v.title.toLowerCase().includes(lowerCaseSearchTerm)) {
                                videoList += `
                                    <li>
                                        <a href="${v.url}" target="_blank">${v.title}</a>
                                        <div class="actions">
                                            <button class="action-btn edit-btn" data-doc-id="${v.id}" data-title="${v.title}" data-url="${v.url}">‚úèÔ∏è</button>
                                            <button class="action-btn delete-btn" data-doc-id="${v.id}">üóëÔ∏è</button>
                                        </div>
                                    </li>`;
                                chapterHasContent = true;
                            }
                        });

                        // Filter PDFs
                        chapterData.pdfs.forEach(p => {
                            if (!searchTerm || p.title.toLowerCase().includes(lowerCaseSearchTerm)) {
                                pdfList += `
                                    <li>
                                        <a href="${p.url}" target="_blank">${p.title}</a>
                                        <div class="actions">
                                            <button class="action-btn edit-btn" data-doc-id="${p.id}" data-title="${p.title}" data-url="${p.url}">‚úèÔ∏è</button>
                                            <button class="action-btn delete-btn" data-doc-id="${p.id}">üóëÔ∏è</button>
                                        </div>
                                    </li>`;
                                chapterHasContent = true;
                            }
                        });

                        // Only add chapter card if it has content OR its title matches the search
                        if (chapterHasContent || (!searchTerm && !chapterHasContent) || (searchTerm && chapterName.toLowerCase().includes(lowerCaseSearchTerm))) {
                             subjectContent += `<div class="chapter-card"><h4>${chapterName}</h4>`;
                             if (videoList) subjectContent += `<div class="content-type-header">Videos</div><ul>${videoList}</ul>`;
                             if (pdfList) subjectContent += `<div class="content-type-header">PDFs</div><ul>${pdfList}</ul>`;
                             if(!videoList && !pdfList && searchTerm) subjectContent += `<p><em>No matching content in this chapter.</em></p>`;
                             subjectContent += `</div>`;
                        }
                    }
                    if (subjectContent) {
                        classContent += `<div class="subject-block"><h3>Subject: ${subjectName}</h3>${subjectContent}</div>`;
                    }
                }
                if (classContent) {
                    html += `<div class="class-block"><div class="class-header"><h2>Class: ${className}</h2></div><div class="class-content">${classContent}</div></div>`;
                }
            }
            libraryContainer.innerHTML = html || `<p>No results found for "${searchTerm}"</p>`;
        }
        
        // --- EVENT LISTENERS ---

        // Search functionality
        searchInput.addEventListener('input', () => {
            renderLibrary(fullLibraryData, searchInput.value);
        });

        // Edit/Delete click handling using Event Delegation
        libraryContainer.addEventListener('click', (e) => {
            const target = e.target;
            const deleteBtn = target.closest('.delete-btn');
            const editBtn = target.closest('.edit-btn');

            if (deleteBtn) {
                const docId = deleteBtn.dataset.docId;
                if (window.confirm('Are you sure you want to delete this item? This cannot be undone.')) {
                    db.collection('content').doc(docId).delete()
                        .then(() => {
                            console.log('Document successfully deleted!');
                            loadContentLibrary(); // Refresh the view
                        })
                        .catch(error => console.error('Error removing document: ', error));
                }
            }

            if (editBtn) {
                document.getElementById('editDocId').value = editBtn.dataset.docId;
                document.getElementById('editTitle').value = editBtn.dataset.title;
                document.getElementById('editUrl').value = editBtn.dataset.url;
                editModal.style.display = 'flex';
            }
        });

        // Modal close button
        cancelEditBtn.addEventListener('click', () => {
            editModal.style.display = 'none';
        });

        // Modal form submission
        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const docId = document.getElementById('editDocId').value;
            const newTitle = document.getElementById('editTitle').value;
            const newUrl = document.getElementById('editUrl').value;

            db.collection('content').doc(docId).update({
                title: newTitle,
                url: newUrl
            }).then(() => {
                console.log('Document successfully updated!');
                editModal.style.display = 'none';
                loadContentLibrary(); // Refresh the view
            }).catch(error => {
                console.error('Error updating document: ', error);
                alert('Failed to update. See console for details.');
            });
        });

        // Initial Load
        document.addEventListener('DOMContentLoaded', loadContentLibrary);
    </script>
</body>
</html>
