<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Result</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .result-summary { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; margin-bottom: 30px; }
        .result-summary h1 { color: #2c3e50; margin-top: 0; }
        .result-summary p { font-size: 1.5rem; font-weight: 500; color: #3498db; }
        .review-container .question-block { background: white; margin-bottom: 20px; padding: 20px; border-radius: 8px; border-left: 5px solid #bdc3c7; }
        .review-container .question-block.correct { border-left-color: #2ecc71; }
        .review-container .question-block.incorrect { border-left-color: #e74c3c; }
        .question-text { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }
        .question-text img, .option-item img { max-width: 100%; height: auto; border-radius: 4px; }
        .option-item { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #eee; }
        .option-item.correct-answer { background-color: #dff9e6; border-color: #2ecc71; font-weight: bold; }
        .option-item.wrong-answer { background-color: #fbecec; border-color: #e74c3c; text-decoration: line-through; }
        .solution { margin-top: 15px; padding: 10px; background: #ecf0f1; border-radius: 4px; color: #34495e; }
        .solution strong { color: #2c3e50; }
        .leaderboard-link { display: inline-block; margin-top: 20px; padding: 12px 25px; background-color: #f39c12; color: white; text-decoration: none; font-weight: 600; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="result-summary" class="result-summary">
            <h1>Test Completed!</h1>
            <p id="score-text">Calculating your score...</p>
            <a id="leaderboard-link" href="#" class="leaderboard-link">View Leaderboard</a>
        </div>
        
        <h2>Review Your Answers</h2>
        <div id="review-container" class="review-container">
            <!-- Review content will be generated here -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDVIgUAmKlJqwvkd9kblaujzIVlSq9_EiM",
            authDomain: "tests-data-with-leaderboard.firebaseapp.com",
            projectId: "tests-data-with-leaderboard",
            storageBucket: "tests-data-with-leaderboard.firebasestorage.app",
            messagingSenderId: "884648979462",
            appId: "1:884648979462:web:446df6ccb02bf73397e787",
            measurementId: "G-701ZP61XZT"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.onload = () => {
            const results = JSON.parse(localStorage.getItem('testResults'));
            const studentName = localStorage.getItem('studentName');
            const urlParams = new URLSearchParams(window.location.search);
            const testId = urlParams.get('testid');

            if (!results || !studentName || !testId) {
                document.body.innerHTML = '<h1>Error: Result data not found. Please complete a test first.</h1>';
                return;
            }

            const { testData, userAnswers } = results;
            const reviewContainer = document.getElementById('review-container');
            let score = 0;

            // Calculate score and render review
            testData.questions.forEach((q, index) => {
                const isCorrect = (q.correctAnswerIndex === userAnswers[index]);
                if (isCorrect) score++;

                const questionBlock = document.createElement('div');
                questionBlock.className = `question-block ${isCorrect ? 'correct' : 'incorrect'}`;
                
                let questionHTML = q.isQuestionImage ? `<img src="${q.questionText}">` : q.questionText;
                let optionsHTML = q.options.map((opt, i) => {
                    let classes = 'option-item';
                    if (i === q.correctAnswerIndex) classes += ' correct-answer';
                    if (i === userAnswers[index] && !isCorrect) classes += ' wrong-answer';
                    
                    let optionContent = opt.isOptionImage ? `<img src="${opt.optionText}">` : opt.optionText;
                    return `<div class="${classes}">${optionContent}</div>`;
                }).join('');

                questionBlock.innerHTML = `
                    <div class="question-text">Q${index + 1}: ${questionHTML}</div>
                    <div class="options">${optionsHTML}</div>
                    <div class="solution"><strong>Solution:</strong> ${q.solution || 'No solution provided.'}</div>
                `;
                reviewContainer.appendChild(questionBlock);
            });

            // Display summary
            document.getElementById('score-text').textContent = `Hi ${studentName}, you scored ${score} out of ${testData.questions.length}.`;
            
            // Set leaderboard link
            document.getElementById('leaderboard-link').href = `5.html?testid=${testId}`;

            // Save to leaderboard
            saveToLeaderboard(testId, studentName, score, testData.questions.length);

            // Clean up localStorage
            localStorage.removeItem('testResults');
            // We can keep studentName for convenience if they take another test
        };

        async function saveToLeaderboard(testId, studentName, score, totalQuestions) {
            try {
                await db.collection('leaderboard').add({
                    testId: testId,
                    studentName: studentName,
                    score: score,
                    totalQuestions: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('Score saved to leaderboard.');
            } catch (error) {
                console.error("Error saving to leaderboard: ", error);
            }
        }
    </script>
</body>
</html>
